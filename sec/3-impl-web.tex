\subsection{Реализация приложения Web-клиента}\label{subsec:3-impl-web}\indent

\subsubsection{Описание архитектурных решений}\indent

Для реализации выбран архитектурный паттерн MVC. Данный паттерн позволяет разделить данные, представление и бизнес-логику.

Все файлы приложения были разделены на 3 слоя:
\begin{enumerate}
    \item Данные – в этот слой входят все файлы, которые отвечающие за представление структур данных, которые используются в приложении.
    Все данные, которые приложение получает с сервера или с локального хранилища представлены в виде интерфейсов данного слоя.
    \item Сервис – на этом уровне выполняется основная бизнес-логика приложения и запросы к серверу.
    Сервис существует для каждого значимого функционала значимой сущности и соответствует \hyperlink{gloss:spr}{SPR (Single Responsibility Principle)}.
    \item Контроллер – на данном слое происходит обработка ошибок и биндинг данных в view, а также происходит управление состоянием view в зависимости от существующих данных, либо статуса загрузки данных с сервера.
\end{enumerate}

Отдельными модулями приложения являются:
\begin{itemize}
    \item Pipes – содержит классы, которые занимаются форматирование данных при отображении.
    Например, CountPipe, PricePipe
    \item Utils – содержит классы, утилиты и икапсулированные обёртки вокруг библиотек, настроенные для использования в реализуемом приложении.
    \item Routing – содержит всю логику и весь маппинг возможных переходов по приложению.
\end{itemize}

\subsubsection{Описание основных сервисов}\indent

В приложении используется аутентификация на сервере по технологии OAuth2, поэтому должна быть реализована логика, 
которая может быть легко встраиваемой в любой компонент при помощи \hyperlink{gloss:di}{DI}. 
Кроме того, должны быть механизмы перезапроса access\_token’а, при наличии refresh\_token’а, в случае истечения срока его действия.
Для этого был реализован AuthorizationService, листинг которого можно увидеть в Приложении \ref{addition:web-authservice}.
Данный сервис инкапсулирует в себе логику для контроля авторизационных процессов.
Поскольку данный класс реализует в себе HttpInterceptor интерфейс, он может быть добавлен как перехватчик к любому исходящему запросу и выполнять необходимую логику перезапроса токена, при наличии refresh\_token’а и получении 403 ошибки при выполнении запроса и добавления токенов в заголовки запроса, при их наличии.
Все токены хранятся в local storage браузера.

CartService занимается контролем за состоянием корзины, а также её управлением.

На каждый из контроллеров сервера, реализованы свои сервисы.

Основная их задача заключается в выполнении запроса к серверу и возвращение подписки на \hyperlink{gloss:ui}{UI}.
При помощи данного callback’а имеется возможность выполнения запросов в сеть без блокирования UI потока.

Пример реализации MgrProductService можно найти в Приложении \ref{addition:web-mgr-product-service}.

Пример реализации подписки на получаемый результат от сервиса представлен на листинге \ref{lis:web-subscription}.

\begin{lstlisting}[language=TypeScript, captionpos=b,
label={lis:web-subscription},
caption={Пример реализации подписки на ожидаемый результат от сервера}
]
private loadProducts(id: number) {
    this.productService.getByCategoryId(id).subscribe(
    products => {
        this.tableConfig.source = new MatTableDataSource<Product>(products);

        setTimeout(() => {
            ProductComponent.scrollToView(this.productActionsSubSection);
            this.tableConfig.source.sort = this.sort;
            this.tableConfig.source.paginator = this.paginator;
        });
    }, error => {
        this.processError(error);
    }, () => this.setLoading(false)
    )
}
\end{lstlisting}

\subsubsection{Описание принципов построения пользовательского интерфейса}\indent

В Angular пользовательский интерфейс состоит из легко встраиваемых компонентов.
Каждый компонент создаётся разработчиком и может управлеяет отображением представления на экране.
Для создания компонента необходимо импортировать функцию декоратора @Component из библиотеки @angular/core.
Данный декоратор позволяет идентифицировать класс как компонент.

Декоратор в качестве параметра принимает объект с конфигурацией, которая указывает фреймворку, как работать с компонентом и его представлением.
С помощью свойства template, шаблон представляет часть HTML разметки с вставкой кода Angular.
Фактически, шаблон и является представлением, которым пользователь управляет при работе с приложением.
Каждый компонент должен обладать одним шаблоном.
Свойство selector определяет селектор CSS. В элемент с этим селектором Angular будет добавлять представление компонента.

Некоторые элементы форм клиентской части и вся \hyperlink{gloss:cms}{CMS}-часть приложения используют Angular Material Components.

Для обеспечения адаптивности приложения используется CSS-Grid Layout.
Данный подход позволяет менять расположение grid элементов не меняя сам HTML. К основным понятиям CSS Grid относят:
\begin{itemize}
    \item Grid container – набор пересекающихся горизонтальных и вертикальных grid линий, которые делят пространство контейнера на области, в которые могут быть помещены grid элементы.
    \item Grid lines – это горизонтальные и вертикальные разделители grid контейнера.
    Эти линии находятся по обе стороны от столбца или строки.
    Разработчик может задать для данного элемента имя или числовой индекс, которые может использовать дальше в стилях.
    Нумерация начинается с единицы.
    Важный нюанс, данный элемент восприимчив к режиму написания, который используется на вашем ресурсе.
    Например, вы используете Арабский язык или любой другой язык у которого режим написания справа налево, то нумерация линий будет начинаться с правой стороны.
    \item Grid track – это пространство между двумя смежными grid линиями, вертикальными или горизонтальными.
    \item Grid cell – это наименьшая неделимая единица grid контейнера на которую можно ссылаться при позиционировании grid элементов.
    Образуется на пересечении grid строки и grid колонки.
    \item Grid area – это пространство внутри grid контейнера, в которое может быть помещен один или больше grid элементов.
    Этот элемент может состоять из одной или более grid ячеек.
\end{itemize}

Каждый элемент тесно связан друг с другом и отвечает за определенную часть grid контейнера.

Пример HTML для ProductAdd компонента можно найти в Приложении \ref{addition:web-product-add}.
CSS для этого компонента находится в Приложении \ref{addition:web-product-add-css}.

\subsubsection{Описание основных сторонних библиотек}\indent

Основные сторонние библиотеки, используемые в приложении:
\begin{itemize}
    \item Ngx-gallery – библиотека предоставляющая компонент для простой реализации автоматической галлереи изображений, обладающая рядом дополнительных функций.
    Используется на странице каталога товаров.
    \item Ngx-infinite-scroll – библиотека предоставляющая возможность порционной загрузки данных по мере приблежения к концу страницы.
    Используется на странице каталога товаров.
    \item RxJs – библиотека для обеспечения возможности реактивного программирования.
    \item Angular4-carousel – библиотека предоставляющая слайдер компонент используемый на главной странице приложения.
    \item Angular-notifier – библиотека предоставляющая настраиваемые всплывающие уведомления, которые используются в ответ на действия пользователя, по всей клиентской части приложения.
    \item Angular-2-local-storage – библиотека предоставляющая абстрактную обёртку вокруг local-storage, которая инкапсулирует всю логику работы с ним и предоставляет удобный интерфейс разработчику.
\end{itemize}

\subsubsection{Сборка и структура проекта}\indent

Для разработки приложения использовался Angular CLI – интерфейс командной строки, который позволяет быстро создавать проекты, добавлять файлы и выполнять множество определённых задач, таких как тестирование, сборка и развёртывание.
Для корректной работы Angular CLI, необходимо чтоб были установлены Node.js и npm.

Для запуска веб-сервера, используемого для разработки приложения необходимо выполнить комманду ng serve –open в дирректории Angular приложения.
Команда ng serve запускает веб-сервер, а также прослушивает каталог c исходниками приложения и при изменениях в этих исходных файлах пересобирает проект «на лету».
Стоит отметить, что в таком режиме проект не сохраняется на диске, он записывается непосредственно в оперативную память.
Использование ключа --open (или просто -o) означает, что после сборки проекта, автоматически откроется браузер (по умолчанию выбранный в операционной системе).

Пример структуры angular приложения представлен на листинге \ref{lis:web-project-structure}.

\begin{lstlisting}[language=TypeScript, captionpos=b,
label={lis:web-project-structure},
caption={Пример структуры angular приложения}]
.
|-- app
|   |-- app.component.css
|   |-- app.component.html
|   |-- app.component.spec.ts
|   |-- app.component.ts
|   `-- app.module.ts
|-- assets
|-- environments
|   |-- environment.prod.ts
|   `-- environment.ts
|-- favicon.ico
|-- index.html
|-- main.ts
|-- polyfills.ts
|-- styles.css
|-- test.ts
|-- tsconfig.app.json
|-- tsconfig.spec.json
`-- typings.d.ts
\end{lstlisting}

Исходники приложения, располагаются в директории src.

\textit{app/app.component.{ts,html,css,spec.ts}} – корневой компонент приложения в который внедряются все остальные компоненты приложения. В нём указан корневой компонент иерархии представления. 
Сопровождается html-шаблоном, css-стилями и юнит-тестами.

\textit{app/app.module.ts} – определяет корневой модуль AppModule, в котором определено как собирается приложение.

\textit{assets/*} – директория, в которой размещаются файлы ресурсов использующиеся в приложении. После сборки приложения, ресурсы копируются без изменений.

\textit{index.html} – главная HTML-страница, которая загружается при посещении пользователем. AngularCLI автоматически добавлет весь JavaScript код и CSS файлы при сборке.

\textit{main.ts} – главная точка входа Angular приложения. По умолчанию приложение компилируется JIT(Just In Time) компилятором и запускает его в браузере.

Пример структуры корневой директории проекта представлен на Листинге \ref{lis:web-root-structure}.

\begin{lstlisting}[language=TypeScript, captionpos=b,
label={lis:web-root-structure},
caption={Пример структуры корневой директории проекта}]
.
|-- README.md
|-- e2e
|-- karma.conf.js
|-- node_modules
|-- package-lock.json
|-- package.json
|-- protractor.conf.js
|-- src
|-- tsconfig.json
`-- tslint.json

\end{lstlisting}

\textit{node\_modules/} – окружение Node.js создает данную директорию, в которой хранятся все сторонние модули, подключаемые из-вне путём перечисления в package.json.

\textit{.angular-cli.json} – конфигурационный файл AngularCLI. Посредством этой конфигурации можно установить некоторые из значений сборки по умолчанию, 
а также конфигурировать список файлов которые будут использованы при сборке проекта.

\textit{.editorconfig} – конфигурационный файл редактора кода. Специфицирует конфигурацию форматирования текста кода, 
большинство современных редакторов кода поддерживает конфигурацию полученную из данного файла.

\textit{.gitignore} – файл контроля версий, содержит список файлов которые надо игнорировать при загрузке не в систему контроля версий Git-репозиторий.
К разряду не нужных файлов относятся файлы сгенерированные редактором кода библиотеками кодогенерации.

\textit{package.json} – конфигурационный файл npm, в нем перечисляются сторонние модули (пакеты) разработчиков, которые использует ваш проект.

\textit{tsconfig.json} – конфигурация компилятора TypeScript для редактора кода.

\textit{tslint.json} – конфигурация для статического анализатора TSLint, используется при запуске ng lint.
