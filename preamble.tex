\usepackage{fontspec} % XeTeX
\usepackage{xunicode} % Unicode для XeTeX
\usepackage[utf8x]{inputenc}
\usepackage[english,russian]{babel}

%code listings
\usepackage{listings}

\usepackage[dvipsnames]{xcolor}

\definecolor{lightgray}{rgb}{.93,.93,.93}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}

\lstdefinelanguage{TypeScript}{
  keywords={this, typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
  ndkeywords={private, class, export, boolean, number, throw, implements, import, this},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]"
}

\lstdefinelanguage{Kotlin}{
  comment=[l]{//},
  keywords={init, inner, abstract, actual, as, as?, break, by, class, companion, continue, data, do, dynamic, else, enum, expect, false, final, for, fun, get, if, import, in, interface, internal, is, null, object, override, package, private, public, return, set, super, suspend, this, throw, true, try, typealias, val, var, vararg, when, where, while},
  morecomment=[s]{/*}{*/},
  morestring=[b]",
  morestring=[s]{"""*}{*"""},
  ndkeywords={@Deprecated, @JvmField, @JvmName, @JvmOverloads, @JvmStatic, @JvmSynthetic, Array, Byte, Double, Float, Int, Integer, Iterable, Long, Runnable, Short, String, Unit},
  sensitive=true,
}

\lstdefinelanguage{HTML5}{
  language=html,
  sensitive=true,
  alsoletter={<>=-},
  otherkeywords={
    <html>, <head>, <title>, </title>, <meta, />, </head>, <body>,
    <form, </form>,
    <mat-horizontal-stepper, </mat-horizontal-stepper>,
    <mat-step, </mat-step>,
    <mat-form-field, <\/mat-form-field>,
    <mat-step, </mat-step>,
    <mat-checkbox, </mat-checkbox>,
    <ng-container, </ng-container>,
    <mat-slide-toggle, </mat-slide-toggle>,
    <mat-card>, </mat-card>,
    <mat-card-title>, </mat-card-title>,
    <mat-card-subtitle>, </mat-card-subtitle>,
    <mat-card-content>, </mat-card-content>,
    <mat-divider>,</mat-divider>,
    <mat-list, </mat-list>,
    <mat-list-item, </mat-list-item>,
    <table, <tr>, <td>, </tr>, </td>, </table>,
    <input, <mat-error, </mat-error>,
    <div>, </div>, <div ,
    <span, </span>, <button, </button>,
    <canvas, \/canvas>, <script>, </script>, </body>, </html>, <!, html>, <style>, </style>, ><
  },
  ndkeywords={
    =, matInput, ngIf, ngFor, ngSwitchCase, mat-raised-button, matStepperNext, matStepperPrevious,
    charset=, id=, width=, height=,
    border:, transform:, -moz-transform:, transition-duration:, transition-property:, transition-timing-function:
  },
  morecomment=[s]{<!--}{-->},
  tag=[s]
}

\lstdefinelanguage{CSS}{
  morestring=[s]{:}{;},
  sensitive,
  morecomment=[s]{/*}{*/}
}

\lstset{
  extendedchars=true,
  basicstyle=\linespread{0.3}\ttfamily\scriptsize,
  showstringspaces=false,
  showspaces=false,
  numbers=left,
  numberstyle=\footnotesize,
  numbersep=8pt,
  tabsize=2,
  breaklines=true,
  showtabs=true,
  captionpos=b,
  identifierstyle=\color{black},
  emphstyle={\color{OrangeRed}},
  keywordstyle={\color{NavyBlue}\bfseries},
  commentstyle=\color{purple}\ttfamily,
  ndkeywordstyle={\color{Blue}\bfseries},
  stringstyle={\color{ForestGreen}\ttfamily},
}

% Шрифты, xelatex
\defaultfontfeatures{Ligatures=TeX}
\setmainfont{Times New Roman}
\newfontfamily\cyrillicfont{Times New Roman}
\setmonofont{FreeMono} % Моноширинный шрифт для оформления кода

% Русский язык
\usepackage{polyglossia}
\setdefaultlanguage{russian}

\usepackage{enumerate}
\usepackage{indentfirst}
\usepackage{float}

%images
\usepackage{graphicx}
\graphicspath{{images/}}
\usepackage{chngcntr}

\usepackage{hyperref}
\hypersetup{
  colorlinks, urlcolor={black}, % Все ссылки черного цвета, кликабельные
  linkcolor={black}, citecolor={black}, filecolor={black}
}
\urlstyle{rm}

\renewcommand{\baselinestretch}{1.5} % Полуторный межстрочный интервал
\parindent 12mm % Абзацный отступ

\sloppy             % Избавляемся от переполнений
\hyphenpenalty=10000 % Частота переносов
% \widowpenalties=3 10000 10000 150
\clubpenalty=10000  % Запрещаем разрыв страницы после первой строки абзаца
% \widowpenalty=10000 % Запрещаем разрыв страницы после последней строки абзаца
% 
%page paddings
\usepackage[
  left=3cm,
  right=1cm,
  top=2cm,
  bottom=2cm
]{geometry}

\usepackage{enumitem}
\setlist[enumerate,itemize]{leftmargin=15mm, nolistsep} % Отступы в списках
% \setitemize[1]{labelindent=4cm,itemindent=4cm}

\makeatletter
\AddEnumerateCounter{\asbuk}{\@asbuk}{м)}
\makeatother
\renewcommand{\labelitemi}{\bfseries\textbullet} % Маркер списка
\renewcommand{\labelenumii}{\theenumii}
\renewcommand{\theenumii}{\theenumi.\arabic{enumii}.}

% Содержание
\usepackage{tocloft}
\renewcommand{\cfttoctitlefont}{\hspace{0.38\textwidth}\MakeTextUppercase} % СОДЕРЖАНИЕ
\renewcommand{\cftsecfont}{\hspace{0pt}}            % Имена секций в содержании не жирным шрифтом
\renewcommand\cftsecleader{\cftdotfill{\cftdotsep}} % Точки для секций в содержании
\renewcommand\cftsecpagefont{\mdseries}             % Номера страниц не жирные
\setcounter{tocdepth}{2}                            % Глубина оглавления, до subsubsection
\addtocontents{toc}{\protect\thispagestyle{empty}}

% Нумерация страниц посередине сверху
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\rhead{\textrm{\thepage}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\setlength{\headheight}{0pt}
\setlength{\footheight}{0pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \rhead{\textrm{\thepage}}
}

% Формат подрисуночных надписей
\RequirePackage{caption}
\DeclareCaptionLabelSeparator{defffis}{ -- } % Разделитель
\captionsetup[figure]{font=small, justification=centering, labelsep=defffis, format=plain, labelfont=bf, textfont=bf} % Подпись рисунка по центру
\captionsetup[table]{font=small, justification=raggedright, labelsep=defffis, format=plain, singlelinecheck=false} % Подпись таблицы слева
\captionsetup[lstlisting]{justification=centering, labelsep=defffis, format=plain, labelfont=bf, textfont=bf} % Подпись листинга по центру
\addto\captionsrussian{\renewcommand{\figurename}{Рисунок}} % Имя фигуры
\addto\captionsrussian{\renewcommand{\lstlistingname}{Листинг}} % TODO check listing numbering
%\addto\captionsrussian{\renewcommand{\lstlistingname}{Листинг \thesection.\arabic{lstlisting}}}
\renewcommand{\thefigure}{\thesection.\arabic{figure}}

% Заголовки секций в оглавлении в верхнем регистре
\usepackage{textcase}
\makeatletter
\let\oldcontentsline\contentsline
\def\contentsline#1#2{
  \expandafter\ifx\csname l@#1\endcsname\l@section
  \expandafter\@firstoftwo
  \else
  \expandafter\@secondoftwo
  \fi
  {\oldcontentsline{#1}{\MakeTextUppercase{#2}}}
  {\oldcontentsline{#1}{#2}}
}
\makeatother

% Оформление заголовков
\usepackage[compact,explicit]{titlesec}
\titleformat{\section}{\large\bfseries}{}{0mm}{\clearpage\centering{\MakeUppercase{#1}}\vspace{18pt}\setcounter{figure}{0}\setcounter{lstlisting}{0}}
\titleformat{\subsection}[block]{\fontsize{15}{18}\selectfont\bfseries}{}{1.5cm}{\thesubsection\quad#1}
\titleformat{\subsubsection}[block]{\normalsize\bfseries}{}{15mm}{\thesubsubsection\quad#1}
\titleformat{\paragraph}[block]{\normalsize}{}{12.5mm}{\MakeTextUppercase{#1}}
\titlespacing*{\subsection}{0mm}{0.3em}{0.2em}

\usepackage{lastpage} % Подсчет количества страниц
\setcounter{page}{2}  % Начало нумерации страниц

% Пользовательские функции
% Секции без номеров (введение, заключение...), вместо section*{}
\newcommand{\anonsection}[1]{
  \section*{#1}\label{sec:#1}
  \addcontentsline{toc}{section}{#1}
}

\newcommand{\addimg}[4]{ % Добавление одного рисунка
  \begin{figure}
    \centering
    \includegraphics[width=#2\linewidth]{#1}
    \caption{\small\bfseries{#3}} \label{#1}
  \end{figure}
}
\newcommand{\addimghere}[4]{ % Добавить рисунок непосредственно в это место
  \begin{figure}[H]
    \centering
    \includegraphics[width=#2\linewidth]{#1}
    \ifx&#3&%
    \else
    \caption{\small#3} \label{#1}
    \fi
  \end{figure}
}

\newcommand\capmystring[1]{\capmystringaux#1\relax}
\def\capmystringaux#1#2\relax{\uppercase{#1}\lowercase{#2}}
%\newcounter{additionCounter}
\newcommand{\addition}[3] {
  \clearpage
  \refstepcounter{additionCounter}
  \label{addition:#1}
  \addcontentsline{toc}{section}{
    \emph{\capmystring{Приложение} \theadditionCounter}. \capmystring{#2}
  }

  \begin{flushright}
    \MakeUppercase{Приложение} \theadditionCounter
  \end{flushright}

  \begin{center}
    \large\bfseries#2
  \end{center}

  #3
}

\definecolor{shadecolor}{RGB}{255,255,0}
\newcommand{\TODO}[1]{\setlength\fboxsep{15pt}\par\noindent\colorbox{shadecolor}
{\textcolor{red}{\bfseries\parbox{\dimexpr\textwidth-2\fboxsep\relax}{TODO: #1}}}}

% Declare counters

\usepackage{xassoccnt}
\NewTotalDocumentCounter{totalfigures}
\NewTotalDocumentCounter{totallistings}
\NewTotalDocumentCounter{additionCounter}
\NewTotalDocumentCounter{biblioCounter}
\DeclareAssociatedCounters{figure}{totalfigures}
\DeclareAssociatedCounters{lstlisting}{totallistings}
\setcounter{additionCounter}{0}

\def\oldbibitem{} \let\oldbibitem=\bibitem
\def\bibitem{\stepcounter{biblioCounter}\oldbibitem}

\usepackage[autostyle]{csquotes}